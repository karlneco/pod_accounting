{% extends "base.html" %}
{% block extra_styles %}
  <style>
    tbody tr > :first-child {
      position: sticky;
      z-index: 1;
      left: 0;
    }
    tbody th > :first-child {
      position: sticky;
      z-index: 1;
      left: 0;
    }
    .sticky-col {
      position: sticky;
      left: 0;
      background: white;
      z-index: 2;
      box-shadow: 2px 0 5px -2px #ccc;
      min-width: 250px;
    }
  </style>
  {% endblock %}
{% block content %}
<div class="container-fluid mt-5">
  <h1>Profit and Loss</h1>
  <p class="text-muted">
    {{ start_date or '…' }} – {{ end_date or '…' }}
  </p>

  {% include "_date_filter.html" %}

  <!-- Granularity selector -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="granularity" class="form-label">Time Granularity</label>
      <select id="granularity" class="form-select" onchange="changeGranularity()">
        <option value="month" {% if granularity == 'month' %}selected{% endif %}>Monthly</option>
        <option value="week" {% if granularity == 'week' %}selected{% endif %}>Weekly</option>
        <option value="day" {% if granularity == 'day' %}selected{% endif %}>Daily</option>
      </select>
    </div>
  </div>

  <div id="pl-table-container" style="overflow-x: auto; width: 100%; max-width: 80vw;">
    <table id="pl-table" class="table table-sm" style="min-width: 800px;">
      <!-- Header with period columns -->
      <thead class="table-light">
        <tr>
          <th class="sticky-col" style="background: white;">Account</th>
          {% for col in period_columns %}
          <th class="text-end" style="min-width: 120px;">{{ col.label }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="min-width: 140px; position: sticky; right: 0; background: #f8f9fa; z-index: 1;">Total</th>
        </tr>
      </thead>

      <!-- Income section -->
      <tbody>
        <tr class="table-primary">
          <td class="sticky-col">Income</td>
          {% for col in period_columns %}
          <td style="background: #cfe2ff;"></td>
          {% endfor %}
          <td style="background: #cfe2ff;"></td>
        </tr>
        <tr>
          <td class="sticky-col"><strong>Number of Orders</strong></td>
          {% for col in period_columns %}
          <td class="text-end"><strong>{{ order_counts_by_period.get(col.key, 0) }}</strong></td>
          {% endfor %}
          <td class="text-end table-secondary" style="position: sticky; right: 0; background: #f8f9fa; z-index: 1;"><strong>{{ order_counts_by_period.values() | sum }}</strong></td>
        </tr>
        
        {% for item in income %}
        <tr>
          <td class="sticky-col">{{ item.name }}</td>
          {% for col in period_columns %}
          <td class="text-end">${{ '{:,.2f}'.format(item.periods[col.key]) }}</td>
          {% endfor %}
          <td class="text-end table-secondary" style="position: sticky; right: 0; background: #f8f9fa; z-index: 1;">${{ '{:,.2f}'.format(item.total) }}</td>
        </tr>
        {% endfor %}
        
        <tr class="table-light">
          <th class="sticky-col" style="background: #f8f9fa">Total Income</th>
          {% for col in period_columns %}
          <th class="text-end">${{ '{:,.2f}'.format(period_totals.income[col.key]) }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="position: sticky; right: 0; background: #dee2e6; z-index: 1;">${{ '{:,.2f}'.format(period_totals.income.values() | sum) }}</th>
        </tr>
      </tbody>

      <!-- COGS section -->
      <tbody>
        <tr class="table-warning">
          <td class="sticky-col">Cost of Goods Sold</td>
          {% for col in period_columns %}
          <td style="background: #fff3cd;"></td>
          {% endfor %}
          <td style="background: #fff3cd;"></td>
        </tr>

        {% for item in cogs %}
        <tr>
          <td class="sticky-col">{{ item.name }}</td>
          {% for col in period_columns %}
          <td class="text-end">${{ '{:,.2f}'.format(item.periods[col.key]) }}</td>
          {% endfor %}
          <td class="text-end table-secondary" style="position: sticky; right: 0; background: #f8f9fa; z-index: 1;">${{ '{:,.2f}'.format(item.total) }}</td>
        </tr>
        {% endfor %}

        <tr class="table-light">
          <th class="sticky-col" style="background: #f8f9fa; z-index: 1;">Total COGS</th>
          {% for col in period_columns %}
          <th class="text-end">${{ '{:,.2f}'.format(period_totals.cogs[col.key]) }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="position: sticky; right: 0; background: #dee2e6; z-index: 1;">${{ '{:,.2f}'.format(period_totals.cogs.values() | sum) }}</th>
        </tr>
      </tbody>

      <!-- Gross Profit -->
      <tbody>
        <tr>
          <th class="sticky-col" style="background: #d1ecf1; z-index: 1;">Gross Profit</th>
          {% for col in period_columns %}
          <th style="background: #d1ecf1;" class="text-end">${{ '{:,.2f}'.format(period_totals.gross_profit[col.key]) }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="position: sticky; right: 0; background: #dee2e6; z-index: 1;">${{ '{:,.2f}'.format(period_totals.gross_profit.values() | sum) }}</th>
        </tr>
      </tbody>

      <!-- Expenses section -->
      <tbody>
        <tr class="table-danger">
          <td class="sticky-col">Expenses</td>
          {% for col in period_columns %}
          <td style="background: #f8d7da;"></td>
          {% endfor %}
          <td style="background: #f8d7da;"></td>
        </tr>
        {% for item in expenses %}
        <tr>
          <td class="sticky-col">
            <a href="{{ url_for('accounts.account_transactions',
                               account_id=item.id,
                               range=range_key,
                               start=start_date,
                               end=end_date) }}">
              {{ item.name }}
            </a>
          </td>
          {% for col in period_columns %}
          <td class="text-end">${{ '{:,.2f}'.format(item.periods[col.key]) }}</td>
          {% endfor %}
          <td class="text-end table-secondary" style="position: sticky; right: 0; background: #f8f9fa; z-index: 1;">${{ '{:,.2f}'.format(item.total) }}</td>
        </tr>
        {% endfor %}
        <tr class="table-light">
          <th class="sticky-col" style="background: #f8f9fa; z-index: 1;">Total Expenses</th>
          {% for col in period_columns %}
          <th class="text-end">${{ '{:,.2f}'.format(period_totals.expenses[col.key]) }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="position: sticky; right: 0; background: #dee2e6; z-index: 1;">${{ '{:,.2f}'.format(period_totals.expenses.values() | sum) }}</th>
        </tr>
      </tbody>

      <!-- Net Profit -->
      <tbody>
        <tr>
          <th class="sticky-col" style="background: #343a40; color: white;">Net Profit</th>
          {% for col in period_columns %}
          <th  style="background: #343a40; color: white" class="text-end">${{ '{:,.2f}'.format(period_totals.net_profit[col.key]) }}</th>
          {% endfor %}
          <th class="text-end table-secondary" style="position: sticky; right: 0; background: #dee2e6; z-index: 1;">${{ '{:,.2f}'.format(period_totals.net_profit.values() | sum) }}</th>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
function changeGranularity() {
    const granularity = document.getElementById('granularity').value;
    const url = new URL(window.location);
    url.searchParams.set('granularity', granularity);
    window.location.href = url.toString();
}

function setPLTableWidth() {
  const container = document.getElementById('pl-table-container');
  const table = document.getElementById('pl-table');
  if (!container || !table) return;
  // Make the table 120% of the container width, or at least 800px
  const minWidth = 800;
  const newWidth = Math.max(container.offsetWidth * 1.2, minWidth);
  table.style.width = newWidth + 'px';
}

window.addEventListener('DOMContentLoaded', setPLTableWidth);
window.addEventListener('resize', setPLTableWidth);
</script>
{% endblock %}
